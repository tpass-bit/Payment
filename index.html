<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SuzzyPay • Secure Wallet</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode@3.5.1/build/qrcode.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
<body class="dark">
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-wallet"></i>
        <span>SuzzyPay</span>
      </div>
      <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
      </button>
    </header>

    <!-- Wallet Section -->
    <div class="card">
      <h2 class="card-title"><i class="fas fa-wallet"></i> My Wallet</h2>
      <div id="noWallet" class="alert alert-info">
        <p>No wallet found. Create or import one to start.</p>
      </div>
      <div id="walletInfo" class="hidden">
        <div class="form-group">
          <label>Your Wallet Address</label>
          <div class="address-display" id="addrDisplay">
            <span id="addr">No wallet loaded</span>
            <button class="copy-btn" onclick="copyToClipboard('addr')">
              <i class="far fa-copy"></i>
            </button>
          </div>
        </div>
        <div class="qr-container">
          <canvas id="qrCode"></canvas>
        </div>
        <button class="btn btn-danger btn-block" onclick="clearWallet()">
          <i class="fas fa-trash-alt"></i> Logout
        </button>
      </div>
      <div class="btn-group">
        <button class="btn btn-primary" onclick="generateWallet()">
          <i class="fas fa-plus-circle"></i> Create Wallet
        </button>
        <button class="btn btn-secondary" onclick="importWallet()">
          <i class="fas fa-file-import"></i> Import Wallet
        </button>
      </div>
    </div>

    <!-- Balance Section -->
    <div class="card hidden" id="balanceSection">
      <h2 class="card-title"><i class="fas fa-coins"></i> Balance</h2>
      <div class="balance-display" id="bal">0 SUZ</div>
      <button class="btn btn-primary btn-block" onclick="showBalance()">
        <i class="fas fa-sync-alt"></i> Refresh Balance
      </button>
    </div>

    <!-- Send Tokens -->
    <div class="card hidden" id="sendSection">
      <h2 class="card-title"><i class="fas fa-paper-plane"></i> Send SUZ</h2>
      <div class="form-group">
        <label for="to">Recipient Address</label>
        <input type="text" id="to" placeholder="0x...">
      </div>
      <div class="form-group">
        <label for="amt">Amount (SUZ)</label>
        <input type="number" id="amt" placeholder="0.0" step="0.1">
      </div>
      <button class="btn btn-primary btn-block" onclick="sendToken()">
        <i class="fas fa-paper-plane"></i> Send
      </button>
    </div>

    <!-- Transaction History -->
    <div class="card hidden" id="historySection">
      <h2 class="card-title"><i class="fas fa-history"></i> Transactions</h2>
      <ul class="tx-list" id="txList"></ul>
      <div id="noTxs" class="alert alert-info">
        No transactions yet.
      </div>
    </div>

    <!-- Activity Log -->
    <div class="card hidden" id="logSection">
      <h2 class="card-title"><i class="fas fa-terminal"></i> Activity Log</h2>
      <pre id="log"></pre>
    </div>
  </div>

  <script>
    /* ---------- CONFIG ---------- */
    const RPC_URL = "https://polygon-mumbai.g.alchemy.com/v2/demo"; // Replace with your RPC
    const TOKEN_ADDRESS = "0xYourTokenAddress"; // Replace with your token contract
    const TOKEN_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function transfer(address to, uint amount) returns (bool)",
      "event Transfer(address indexed from, address indexed to, uint amount)"
    ];
    const TOKEN_DECIMALS = 18;
    const TOKEN_SYMBOL = "SUZ";

    /* ---------- GLOBALS ---------- */
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    let wallet;
    let tokenContract;
    let transactionHistory = [];

    /* ---------- UTILS ---------- */
    const log = (message, type = 'info') => {
      const logElement = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? 'red' : type === 'success' ? 'green' : 'gray';
      logElement.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
      logElement.scrollTop = logElement.scrollHeight;
    };

    const saveKey = (pk) => localStorage.setItem("suzzypay_pk", pk);
    const loadSaved = () => localStorage.getItem("suzzypay_pk");
    const clearKey = () => localStorage.removeItem("suzzypay_pk");

    const copyToClipboard = (elementId) => {
      const element = document.getElementById(elementId);
      const text = element.innerText || element.textContent;
      navigator.clipboard.writeText(text.trim()).then(() => {
        log("Copied to clipboard!");
      }).catch(err => {
        log("Failed to copy: " + err, 'error');
      });
    };

    const formatAddress = (address) => {
      return `${address.substring(0, 6)}...${address.substring(address.length - 4)}`;
    };

    /* ---------- WALLET FUNCTIONS ---------- */
    async function generateWallet() {
      try {
        wallet = ethers.Wallet.createRandom().connect(provider);
        saveKey(wallet.privateKey);
        await initTokenContract();
        showWalletInfo();
        log("New wallet created. Backup your private key!", 'success');
      } catch (error) {
        log("Wallet creation failed: " + error.message, 'error');
      }
    }

    async function importWallet() {
      const pk = prompt("Enter your private key (0x...)");
      if (!pk || !pk.startsWith("0x") || pk.length !== 66) {
        log("Invalid private key", 'error');
        return;
      }
      
      try {
        wallet = new ethers.Wallet(pk, provider);
        saveKey(pk);
        await initTokenContract();
        showWalletInfo();
        log("Wallet imported!", 'success');
      } catch (error) {
        log("Import failed: " + error.message, 'error');
      }
    }

    function clearWallet() {
      if (!confirm("Are you sure? You will lose access if you don’t have your private key.")) return;
      wallet = null;
      clearKey();
      document.getElementById('noWallet').classList.remove('hidden');
      document.getElementById('walletInfo').classList.add('hidden');
      document.getElementById('balanceSection').classList.add('hidden');
      document.getElementById('sendSection').classList.add('hidden');
      document.getElementById('historySection').classList.add('hidden');
      document.getElementById('logSection').classList.add('hidden');
      log("Wallet cleared.");
    }

    function showWalletInfo() {
      document.getElementById('noWallet').classList.add('hidden');
      document.getElementById('walletInfo').classList.remove('hidden');
      document.getElementById('balanceSection').classList.remove('hidden');
      document.getElementById('sendSection').classList.remove('hidden');
      document.getElementById('historySection').classList.remove('hidden');
      document.getElementById('logSection').classList.remove('hidden');
      
      document.getElementById('addr').textContent = wallet.address;
      document.getElementById('addrDisplay').textContent = wallet.address;
      
      // Generate QR Code
      QRCode.toCanvas(document.getElementById('qrCode'), wallet.address, {
        width: 200,
        margin: 2,
        color: {
          dark: '#ffffff',
          light: '#00000000'
        }
      });
      
      // Load balance
      showBalance();
    }

    /* ---------- TOKEN FUNCTIONS ---------- */
    async function initTokenContract() {
      tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, wallet);
    }

    async function showBalance() {
      if (!wallet) return;
      try {
        const balance = await tokenContract.balanceOf(wallet.address);
        const formatted = ethers.formatUnits(balance, TOKEN_DECIMALS);
        document.getElementById('bal').textContent = `${parseFloat(formatted).toFixed(4)} ${TOKEN_SYMBOL}`;
        log("Balance updated.");
      } catch (error) {
        log("Balance check failed: " + error.message, 'error');
      }
    }

    async function sendToken() {
      if (!wallet) return log("No wallet loaded", 'error');
      
      const to = document.getElementById('to').value.trim();
      const amt = document.getElementById('amt').value.trim();
      
      if (!ethers.isAddress(to)) return log("Invalid address", 'error');
      if (!amt || isNaN(amt)) return log("Invalid amount", 'error');
      
      try {
        const amount = ethers.parseUnits(amt, TOKEN_DECIMALS);
        log(`Sending ${amt} ${TOKEN_SYMBOL} to ${formatAddress(to)}...`);
        
        const tx = await tokenContract.transfer(to, amount);
        log(`Transaction sent: ${tx.hash}`);
        
        await tx.wait();
        log("✅ Transaction confirmed!", 'success');
        
        // Update balance & history
        showBalance();
        document.getElementById('to').value = '';
        document.getElementById('amt').value = '';
      } catch (error) {
        log("Send failed: " + error.message, 'error');
      }
    }

    /* ---------- INITIALIZE ---------- */
    window.addEventListener('load', async () => {
      const savedKey = loadSaved();
      if (savedKey) {
        try {
          wallet = new ethers.Wallet(savedKey, provider);
          await initTokenContract();
          showWalletInfo();
          log("Wallet loaded from storage.");
        } catch (error) {
          log("Failed to load wallet: " + error.message, 'error');
          clearKey();
        }
      }
    });
  </script>
</body>
</html>
