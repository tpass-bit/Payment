<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SuzzyPay • Secure Wallet</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.11.1/dist/ethers.umd.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
  <div class="container">
    <!-- Auth Screen -->
    <div class="auth-box" id="authBox">
      <h1><i class="fas fa-wallet"></i> SuzzyPay</h1>
      <div id="loginForm">
        <input type="email" id="loginEmail" placeholder="Email">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="login()">Login</button>
        <p class="switch-mode" onclick="showRegister()">Create Account</p>
      </div>
      <div id="registerForm" class="hidden">
        <input type="email" id="registerEmail" placeholder="Email">
        <input type="password" id="registerPassword" placeholder="Password">
        <button onclick="register()">Register</button>
        <p class="switch-mode" onclick="showLogin()">Back to Login</p>
      </div>
    </div>

    <!-- Wallet Dashboard (Hidden Initially) -->
    <div class="wallet-dashboard hidden" id="walletDashboard">
      <header>
        <h2><i class="fas fa-wallet"></i> My Wallet</h2>
        <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
      </header>

      <div class="wallet-card">
        <div class="wallet-address">
          <label>Public Key (Shareable)</label>
          <div class="address-box" id="publicKey">Loading...</div>
          <button onclick="copyToClipboard('publicKey')"><i class="fas fa-copy"></i> Copy</button>
        </div>

        <div class="wallet-address">
          <label>Private Key (Keep Secret!)</label>
          <div class="address-box" id="privateKey">••••••••••••</div>
          <button onclick="revealPrivateKey()"><i class="fas fa-eye"></i> Show</button>
        </div>

        <div class="balance-box">
          <span id="balanceAmount">0</span>
          <span>SUZ</span>
          <button onclick="updateBalance()"><i class="fas fa-sync-alt"></i></button>
        </div>
      </div>

      <!-- Send Tokens Form -->
      <div class="send-form">
        <h3><i class="fas fa-paper-plane"></i> Send SUZ</h3>
        <input type="text" id="sendTo" placeholder="Recipient Public Key">
        <input type="number" id="sendAmount" placeholder="Amount">
        <button onclick="sendTokens()">Send Now</button>
      </div>

      <!-- Transaction History -->
      <div class="tx-history">
        <h3><i class="fas fa-history"></i> Transactions</h3>
        <div class="tx-list" id="txList">
          <p>No transactions yet</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase Config (Replace with your keys)
    const firebaseConfig = {
      apiKey: "AIzaSyBPF1VE82Y3VkZe6IibjqKxBC-XHjM_Wco",
      authDomain: "chat-2024-ff149.firebaseapp.com",
      databaseURL: "https://chat-2024-ff149-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "chat-2024-ff149",
      storageBucket: "chat-2024-ff149.appspot.com",
      messagingSenderId: "146349109253",
      appId: "1:146349109253:android:e593afbf0584762519ac6c"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Blockchain Config
    const RPC_URL = "https://polygon-mumbai.g.alchemy.com/v2/demo";
    const TOKEN_ADDRESS = "0xYourTokenContract";
    const TOKEN_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function transfer(address to, uint amount) returns (bool)"
    ];
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    let wallet;
    let tokenContract;

    // DOM Elements
    const authBox = document.getElementById('authBox');
    const walletDashboard = document.getElementById('walletDashboard');

    /* ===== FIREBASE AUTH ===== */
    function showRegister() {
      document.getElementById('loginForm').classList.add('hidden');
      document.getElementById('registerForm').classList.remove('hidden');
    }

    function showLogin() {
      document.getElementById('registerForm').classList.add('hidden');
      document.getElementById('loginForm').classList.remove('hidden');
    }

    async function login() {
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        loadWallet();
      } catch (error) {
        alert("Login failed: " + error.message);
      }
    }

    async function register() {
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        createNewWallet();
      } catch (error) {
        alert("Registration failed: " + error.message);
      }
    }

    function logout() {
      auth.signOut();
      walletDashboard.classList.add('hidden');
      authBox.classList.remove('hidden');
    }

    /* ===== WALLET MANAGEMENT ===== */
    function generateCleanKey() {
      // Creates keys like "2937MC2" (no symbols)
      const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // No 0,O,1,I
      let result = '';
      for (let i = 0; i < 12; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return result;
    }

    async function createNewWallet() {
      const privateKey = generateCleanKey();
      wallet = new ethers.Wallet(privateKey, provider);
      
      // Save to Firebase
      await db.ref('users/' + auth.currentUser.uid).set({
        publicKey: wallet.address,
        privateKey: privateKey
      });
      
      loadWallet();
    }

    async function loadWallet() {
      const user = auth.currentUser;
      if (!user) return;

      const snapshot = await db.ref('users/' + user.uid).once('value');
      const userData = snapshot.val();

      if (userData) {
        wallet = new ethers.Wallet(userData.privateKey, provider);
        document.getElementById('publicKey').textContent = wallet.address;
        document.getElementById('privateKey').textContent = userData.privateKey;
        
        // Initialize token contract
        tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, wallet);
        
        // Show dashboard
        authBox.classList.add('hidden');
        walletDashboard.classList.remove('hidden');
        
        // Load data
        updateBalance();
        loadTransactions();
      } else {
        createNewWallet();
      }
    }

    /* ===== TOKEN OPERATIONS ===== */
    async function updateBalance() {
      const balance = await tokenContract.balanceOf(wallet.address);
      document.getElementById('balanceAmount').textContent = ethers.formatUnits(balance, 18);
    }

    async function sendTokens() {
      const toAddress = document.getElementById('sendTo').value;
      const amount = document.getElementById('sendAmount').value;
      
      try {
        const tx = await tokenContract.transfer(toAddress, ethers.parseUnits(amount, 18));
        await tx.wait();
        updateBalance();
        loadTransactions();
        alert("Transaction successful!");
      } catch (error) {
        alert("Send failed: " + error.message);
      }
    }

    async function loadTransactions() {
      // Implement transaction loading from blockchain or Firebase
      // Placeholder for actual implementation
    }

    /* ===== UTILITIES ===== */
    function copyToClipboard(elementId) {
      const text = document.getElementById(elementId).textContent;
      navigator.clipboard.writeText(text);
      alert("Copied to clipboard!");
    }

    function revealPrivateKey() {
      const privateKeyElement = document.getElementById('privateKey');
      if (privateKeyElement.textContent === '••••••••••••') {
        privateKeyElement.textContent = wallet.privateKey;
      } else {
        privateKeyElement.textContent = '••••••••••••';
      }
    }

    // Initialize auth state
    auth.onAuthStateChanged(user => {
      if (user) loadWallet();
    });
  </script>
</body>
</html>
